// module 'sendFile' - example from lesson on javascript.ru
var fs = require('fs');
var path = require('path');

module.exports = function(directory, filePath, res) {

    try {
        filePath = decodeURIComponent(filePath);
    } catch(e) {
        res.statusCode = 400;
        res.end("Bad request");
        return;
    }

    if (~filePath.indexOf('\0')) {
        res.statusCode = 400;
        res.end("Bad request");
        return;
    }

    filePath = path.normalize(path.join(directory, filePath));

    if (filePath.indexOf(directory) != 0) {
        res.statusCode = 404;
        res.end("File not found");
        return;
    }

    fs.stat( filePath, function(err, stats) {
      if (err || !stats.isFile) {
          res.statusCode = 404;
          res.end("File not found");
          return;
      }
      sendFile(filePath, res);
    });
}

function sendFile(fileName, res) {

    console.log("Sending file: " + fileName);

    var fileStream = fs.createReadStream(fileName);
    
    fileStream
        .on('error', function () {
            res.statusCode = 500;
            res.end("Server error");
        })
        .pipe(res)
        .on('close', function () {
            fileStream.destroy();
        });
}

/*
function sendFile(filePath, res) {

    fs.readFile(filePath, function(err, content) {
        if (err) throw err;

        var mime = require('mime').lookup(filePath); //npm i mime
        res.setHeader('Content-type', mime + "; charset=utf-8");
        res.end(content);
    });
}  
*/